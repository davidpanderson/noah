<!DOCTYPE html>
<!--- Space Slalom in javascript; version 4.1 --->
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html" charset="utf-8"/>
	<title>Space Slalom 4.1</title>
	<!--- link to the last version of babylon --->
	<script src="babylon.2.5.js"></script>
	<style>
		html, body {
			overflow: hidden;
			width   : 100%;
			height  : 100%;
			margin  : 0;
			padding : 0;
		}

		#renderCanvas {
			width   : 100%;
			height  : 100%;
			touch-action: none;
		}
	</style>
</head>
<body>
	<canvas id="renderCanvas"></canvas>
	<script>
		window.addEventListener('DOMContentLoaded', function(){
			// get the canvas DOM element
			var canvas = document.getElementById('renderCanvas');
			var width = canvas.scrollWidth;
			var height = canvas.scrollHeight;
			console.log(width, height);

			// load the 3D engine
			var engine = new BABYLON.Engine(canvas, true);

			var ntori = 20;

			var tori = [];
			var mousex = width/2, mousey=height/2;

			// createScene function that creates and return the scene
			var createScene = function(){
				// create a basic BJS Scene object
				var scene = new BABYLON.Scene(engine);

				// create a FreeCamera, and set its position to (x:0, y:5, z:-10)
				var camera = new BABYLON.FreeCamera('camera1', new BABYLON.Vector3(0, 0,-10), scene);
				camera.inputs.clear();
				camera.keysUp = [];camera.keysDown = [];camera.keysLeft = [];camera.keysRight = [];

				//var camera = new BABYLON.ArcRotateCamera("ArcRotateCamera", 0, 0, 0, BABYLON.Vector3.Zero(), scene);

				//var camera = new BABYLON.ArcRotateCamera("ArcRotateCamera", 1, 0.8, 10, new BABYLON.Vector3(0, 0, 0), scene);
				//camera.setPosition(new BABYLON.Vector3(0, 0, 50));
				//camera.target = new BABYLON.Vector3(3, 0, 0);

				//var camera = new Camera("camera1", new BABYLON.Vector3(0, 0, -10), scene);

				//camera.setPosition(new BABYLON.Vector3(0, 0, -10));

				// target the camera to scene origin
				camera.setTarget(BABYLON.Vector3.Zero());

				// attach the camera to the canvas
				camera.attachControl(canvas, false);

				// create a basic light, aiming 0,1,0 - meaning, to the sky
				var light = new BABYLON.HemisphericLight('light1', new BABYLON.Vector3(0,1,0), scene);
				//var light2 = new BABYLON.HemisphericLight('light2', new BABYLON.Vector3(-1,0,0), scene);

				for (i=0; i<ntori; i++) {
					var m = new BABYLON.StandardMaterial("texture1", scene);
					m.diffuseColor = new BABYLON.Color3(Math.random(), Math.random(), Math.random());
					torus = BABYLON.Mesh.CreateTorus("torus", 3, .4, 50, scene);
					torus.material = m;
					torus.position.x = 8*(Math.random()-.5);
					torus.position.y = 8*(Math.random()-.5);
					torus.position.z = 60*Math.random();
					torus.rotation = new BABYLON.Vector3(Math.PI/2, 0, 0);
					tori.push(torus);
				}
				var outputplane = BABYLON.Mesh.CreatePlane("outputplane", 25, scene, false);
				outputplane.billboardMode = BABYLON.AbstractMesh.BILLBOARDMODE_ALL;
				outputplane.material = new BABYLON.StandardMaterial("outputplane", scene);
				outputplane.position = new BABYLON.Vector3(-5, 5, 25);
				outputplane.scaling.y = 0.4;

				var outputplaneTexture = new BABYLON.DynamicTexture("dynamic texture", 512, scene, true);
				outputplane.material.diffuseTexture = outputplaneTexture;
				outputplane.material.specularColor = new BABYLON.Color3(0, 0, 0);
				outputplane.material.emissiveColor = new BABYLON.Color3(1, 1, 1);
				
				outputplane.material.backFaceCulling = false;

			//	outputplaneTexture.drawText("alpha", null, 140, "bold 140px verdana", "white", "#0000AA");
				window.addEventListener("mousemove", function() {
					mousex = scene.pointerX;
					mousey = scene.pointerY;
					// console.log(x, y);
					
				});
				
				scene.fogMode = BABYLON.Scene.FOGMODE_EXP;
				scene.fogDensity = .05;
				return scene;
			}

			// call the createScene function
			var scene = createScene();

			var t = 0;
			var v = []
			var	hits = 0
			var	misses = 0
			// run the render loop
			engine.runRenderLoop(function(){
			
				scene.render();
				vx = -(mousex-width/2)/4000;
				vy = (mousey-height/2)/4000;
				//console.log(vx, vy);
				for (i=0; i<ntori; i++) {
					tori[i].position.z -= .03;
					if (tori[i].position.z < -10 ){
					//	console.log("passing ring")
						if (tori[i].position.x**2 + tori[i].position.y**2 < 2.25) {
						//	console.log(tori[i].position.x^2 + tori[i].position.y^2)
							hits = hits + 1;
					//		console.log('hit')
						} else {
							misses = misses + 1;
						//	console.log('miss')
						}
						var hitstring = hits.toString()
						var missstring = misses.toString()
						hitstring = hitstring.concat('   ')
						var score = hitstring.concat(missstring)
						//console.log(score)
						var outputplane = BABYLON.Mesh.CreatePlane("outputplane", 25, scene, false);
						outputplane.billboardMode = BABYLON.AbstractMesh.BILLBOARDMODE_ALL;
						outputplane.material = new BABYLON.StandardMaterial("outputplane", scene);
						outputplane.position = new BABYLON.Vector3(-5, 5, 25);
						outputplane.scaling.y = 0.4;
						var outputplaneTexture = new BABYLON.DynamicTexture("dynamic texture", 512, scene, true);
						outputplane.material.diffuseTexture = outputplaneTexture;
						outputplane.material.specularColor = new BABYLON.Color3(0, 0, 0);
						outputplane.material.emissiveColor = new BABYLON.Color3(1, 1, 1);
						outputplane.material.backFaceCulling = false;
						outputplaneTexture.drawText(score, null, 140, "bold 140px verdana", "white", "#0000AA");
						//console.log(hits)
					//	console.log(misses)
						tori[i].position.z = 80+Math.random()*30;
						if (hits + misses == 20) {
							document.write('hits: ', hits);
							document.write("<br />");
							document.write('misses: ', misses)
						}
					}
					tori[i].position.x += vx;
					tori[i].position.y += vy;
				}
				t += .1;
			});

			// the canvas/window resize event handler
			window.addEventListener('resize', function(){
				engine.resize();
			});
		});
	</script>
</body>
</html>